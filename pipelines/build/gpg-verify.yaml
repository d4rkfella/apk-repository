name: gpg-verify

needs:
  packages:
    - gnupg
    - gpg-agent
    - gnupg-dirmngr
    - curl
    - ca-certificates-bundle
    - busybox
    - wolfi-baselayout

inputs:
  signature-uri:
    description: |
      The URI where the `.asc` file (GPG signature) is located.
    required: true
  public-key-uri:
    description: |
      The public key used for verification.
    required: true
  filename:
    description: |
      The name of file to verify.
    required: true

pipeline:
  - name: "Download and verify GPG signature"
    runs: |
      set -e
      info() { echo "INFO[gpg-verify]:" "$@"; }
      error() { echo "ERROR[gpg-verify]:" "$@"; exit 1; }

      SIGNATURE_URI="${{inputs.signature-uri}}"
      PUBLIC_KEY="${{inputs.public-key-uri}}"
      FILENAME="${{inputs.filename}}"

      [ -n "$SIGNATURE_URI" ] || error "SIGNATURE_URI is required!"
      [ -n "$PUBLIC_KEY" ] || error "PUBLIC_KEY is required!"
      [ -n "$FILENAME" ] || error "FILENAME is required!"

      echo "$PUBLIC_KEY" > /tmp/temp_pubkey.asc | /usr/bin/gpg --import /tmp/temp_pubkey.asc && info "Public key imported successfully" || error "Failed to import public key"

      if curl -fsSLO "$SIGNATURE_URI"; then
        info "Downloaded signature file: $SIGNATURE_FILENAME"
      else
        error "Failed to download signature file from $SIGNATURE_URI"
      fi

      if curl -fsSL "$PUBLIC_KEY" | gpg --import; then
        info "Public key imported successfully."
      else
        error "Failed to import public key."
      fi

      if gpg --verify "$(basename "$SIGNATURE_URI")" "$FILENAME"; then
        info "✅ Signature verification successful!"
      else
        error "❌ Signature verification FAILED! The file might be tampered with."
      fi
