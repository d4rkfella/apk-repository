package:
  name: kubevirt-manager
  version: 1.5.0
  epoch: 0
  description: Simple Angular Frontend Web UI Interface to operate Kubevirt
  dependencies:
    runtime:
      - bash
      - kubectl
      - openresty-custom
  copyright:
    - license: Apache-2.0

environment:
  contents:
    keyring:
      - https://packages.darkfellanetwork.com/melange.rsa.pub
      - https://packages.wolfi.dev/os/wolfi-signing.rsa.pub
    repositories:
      - https://packages.darkfellanetwork.com
      - https://packages.wolfi.dev/os
    packages:
      - nodejs-22
      - npm
      - git
      - busybox
      - luarocks
      - curl
      - wget
pipeline:
  - runs: |
      # Debug: Search for /src/packages in the entire filesystem
      echo "Searching for /src/packages..."
      find / -type d -name "packages" 2>/dev/null

      # If found, list its contents
      if found_path=$(find / -type d -path "*/src/packages" 2>/dev/null); then
        echo "/src/packages found at: $found_path"
        ls -R "$found_path"
      else
        echo "/src/packages not found!"
      fi
      git clone https://github.com/kubevirt-manager/kubevirt-manager
  
  - runs: |
      mkdir -p kubevirt-manager/src/app/src/assets
      cd kubevirt-manager/src/app/src/assets
      git clone https://github.com/novnc/noVNC.git

  - runs: |
      cd kubevirt-manager
      npm run clean
      npm install -g @angular/cli@18.1.1
      npm install
      npm run build
      
  - runs: |
      ls -la /
      luarocks install lua-resty-openidc && \
      luarocks install lua-resty-redis-connector
      mkdir -p ${{targets.destdir}}/usr/openresty/nginx/html/
      mkdir ${{targets.destdir}}/docker-entrypoint.d/
      cp -R kubevirt-manager/dist/kubevirtmgr-webui/browser/* ${{targets.destdir}}/usr/openresty/nginx/html/
      ls -la /var/build/sources
      install -m440 -D /home/runner/work/apk-repository/apk-repository/src/packages/kubevirt-manager/resources/nginx.conf ${{targets.destdir}}/etc/nginx/
      install -m440 -D /home/runner/work/apk-repository/apk-repository/src/packages/kubevirt-manager/resources/default.conf ${{targets.destdir}}/etc/nginx/conf.d
      install -m550 -D /home/runner/work/apk-repository/apk-repository/src/packages/kubevirt-manager/resources/30-tune-worker-processes.sh /home/runner/work/apk-repository/apk-repository/src/packages/kubevirt-manager/resources/45-create-bundle-ca.sh /home/runner/work/apk-repository/apk-repository/src/packages/kubevirt-manager/resources/91-startkubectl.sh ${{targets.destdir}}/docker-entrypoint.d/
      install -m550 -D /home/runner/work/apk-repository/apk-repository/src/packages/kubevirt-manager/resources/docker-entrypoint.sh ${{targets.destdir}}/
