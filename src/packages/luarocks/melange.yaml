package:
  name: luarocks
  version: 3.11.1
  epoch: 0
  description: A package manager for Lua modules
  copyright:
    - license: MIT
  dependencies:
    runtime:
      - wget
      - luajit-dev-custom

environment:
  contents:
    keyring:
      - https://packages.darkfellanetwork.com/melange.rsa.pub
      - https://packages.wolfi.dev/os/wolfi-signing.rsa.pub
    repositories:
      - https://packages.darkfellanetwork.com
      - https://packages.wolfi.dev/os
    packages:
      - build-base
      - busybox
      - luajit-dev-custom

pipeline:
  - uses: fetch
    with:
      uri: https://luarocks.github.io/luarocks/releases/luarocks-${{package.version}}.tar.gz
      expected-sha256: c3fb3d960dffb2b2fe9de7e3cb004dc4d0b34bb3d342578af84f84325c669102
  
  - runs: |
      ./configure \
        --prefix=/usr \
        --with-lua-include=/usr/include/lua \
        --force-config
  
  - uses: autoconf/make
 
  - uses: autoconf/make-install

  - uses: strip

test:
  environment:
    contents:
      packages:
        - wget
  pipeline:
    - uses: test/ldd-check
      with:
        packages: ${{package.name}}
    - name: Check if luarocks utility is available
      runs: |
        luarocks --version
    - name: Test if installing a luarock works
      runs: |
         luarocks install lua-cjsonasd

update:
  enabled: true
  release-monitor:
    identifier: 1856
