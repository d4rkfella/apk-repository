package:
  name: jellyseerr
  version: "2.5.2"
  epoch: 0
  description: Open-source media request and discovery manager for Jellyfin, Plex, and Emby.
  copyright:
    - license: MIT
  dependencies:
    runtime:
      - nodejs-23

environment:
  environment:
    REPRODUCIBLE: false
  contents:
    packages:
      - wolfi-baselayout
      - nodejs-23
      - busybox
      - pnpm
      - patch

pipeline:
  - uses: git-checkout
    with:
      expected-commit: fac453878e3d55b93cfda78908403cce348bb9fa
      repository: https://github.com/fallenbagel/jellyseerr
      tag: v${{package.version}}
      destination: jellyseerr
  
  - name: Build
    working-directory: /home/build/jellyseerr
    runs: |
      export COMMIT_TAG=$(git rev-parse HEAD)
      export NEXT_TELEMETRY_DISABLED=1
      export CYPRESS_INSTALL_BINARY=0
      patch -Np1 -i "../jellyseerr.patch"
      sed -i 's/husky install//' package.json
      echo "{\"commitTag\": \"${COMMIT_TAG}\"}" > committag.json
      pnpm install --frozen-lockfile
      pnpm build
      pnpm prune --prod --ignore-scripts
  
  - name: Delete linux-musl node-modules
    working-directory: /home/build/jellyseerr
    runs: |
      find node_modules -type d \
        -name "*musl*" \
        -print \
        -exec rm -rf {} + \
        -prune
  
  - name: Prepare package
    working-directory: /home/build/jellyseerr
    runs: |
      mkdir -p "${{targets.destdir}}/usr/lib/jellyseerr"
      cp -af package.json jellyseerr-api.yml committag.json next.config.js .next dist public node_modules "${{targets.destdir}}/usr/lib/jellyseerr"
      rm -rf "${{targets.destdir}}"/usr/lib/jellyseerr/.next/cache

  - name: Delete incompatible hermesc binary on arm64
    if: ${{build.arch}} == 'aarch64'
    runs: |
      HERMESC_PATH="./usr/lib/jellyseerr/node_modules/.pnpm/react-native@0.74.2_@babel+core@7.24.7_@babel+preset-env@7.24.7_@babel+core@7.24.7__@ty_4bfb90f3af2c2d37a5ddd988b1957395/node_modules/react-native/sdks/hermesc/linux64-bin/hermesc"
      if [ -f "$HERMESC_PATH" ]; then
        echo "Deleting incompatible hermesc binary: $HERMESC_PATH"
        rm -f "$HERMESC_PATH"
      fi

  - uses: strip

test:
  environment:
    contents:
      packages:
        - curl
        - bash
        - jq
  
  pipeline:
    - name: Check for missing dependancies
      uses: test/tw/ldd-check
      with:
        packages: ${{package.name}}
    
    - name: Run test script
      runs: |
        EXPECTED_VERSION="${{package.version}}" ./test.sh

update:
  enabled: true
  github:
    identifier: fallenbagel/jellyseerr
    strip-prefix: v
