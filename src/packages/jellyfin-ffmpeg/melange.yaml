package:
  name: jellyfin-ffmpeg
  version: 7.0.2_p9
  epoch: 0
  description: Modified version of FFmpeg for Jellyfin
  copyright:
    - license: GPL-3.0-only
environment:
  contents:
    repositories:
      - https://dl-cdn.alpinelinux.org/alpine/edge/main
      - https://dl-cdn.alpinelinux.org/alpine/edge/community
    packages:
      - alpine-base
      - build-base
      - alsa-lib-dev
    	- bzip2-dev
    	- chromaprint-dev
    	- coreutils
    	- dav1d-dev
    	- fontconfig-dev
    	- freetype-dev
    	- fribidi-dev
    	- gmp-dev
    	- imlib2-dev
    	- lame-dev
    	- libass-dev
    	- libbluray-dev
    	- libdrm-dev
    	- libopenmpt-dev
    	- libplacebo-dev
    	- libtheora-dev
    	- libva-dev
    	- libvorbis-dev
    	- libvpx-dev
    	- libwebp-dev
    	- nasm
    	- opencl-dev
    	- openssl-dev
    	- opus-dev
    	- perl-dev
    	- shaderc-dev
    	- vulkan-loader-dev
    	- x264-dev
    	- x265-dev
    	- xz-dev
    	- zimg-dev
    	- zlib-dev
var-transforms:
  - from: ${{package.version}}
    match: _p(\d+)$
    replace: -$1
    to: jellyfin-ffmpeg-package-version
pipeline:
  - uses: melange/git-checkout
    with:
      expected-commit: "9ba6e9a7c905f06c4a895ffe9ef5d19e61f001c2"
      repository: https://github.com/jellyfin/jellyfin-ffmpeg
      tag: v${{vars.jellyfin-ffmpeg-package-version}}
  - runs: |
    for i in debian/patches/*.patch; do
  		patch -p1 -i "$i"
  	done
  - runs: |
      ./configure \
        --prefix="/usr/lib/jellyfin-ffmpeg" \
    		--target-os=linux \
    		--extra-version=Jellyfin \
    		--disable-doc \
    		--disable-ffplay \
    		--disable-librtmp \
    		--disable-libxcb \
    		--disable-sdl2 \
    		--disable-shared \
    		--disable-xlib \
    		--enable-chromaprint \
    		--enable-gmp \
    		--enable-gpl \
    		--enable-libass \
    		--enable-libbluray \
    		--enable-libdav1d \
    		--enable-libdrm \
    		--enable-libfontconfig \
    		--enable-libfreetype \
    		--enable-libfribidi \
    		--enable-libmp3lame \
    		--enable-libopenmpt \
    		--enable-libopus \ 
    		--enable-libplacebo \
    		--enable-libshaderc \
    		--enable-libtheora \
    		--enable-libvorbis \
    		--enable-libvpx \
    		--enable-libwebp \
    		--enable-libx264 \
    		--enable-libx265 \
    		--enable-libzimg \
    		--enable-opencl \
    		--enable-openssl \
    		--enable-pic \
    		--enable-pthreads \
    		--enable-static \
    		--enable-vaapi \
    		--enable-version3 \
    		--enable-vulkan \
        --enable-libvpl
  - runs: make
  - runs: |
      mkdir -p "${{targets.destdir}}/usr/lib/jellyfin-ffmpeg"
      install -Dm755 -t "${{targets.destdir}}/usr/lib/jellyfin-ffmpeg" ffmpeg ffprobe
  - uses: strip
