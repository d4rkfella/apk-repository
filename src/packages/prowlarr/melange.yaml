package:
  name: prowlarr
  version: "2.1.2.5186"
  epoch: 0
  description: Prowlarr is an indexer manager/proxy built on the popular *arr .net/reactjs base stack to integrate with your various PVR apps. Prowlarr supports management of both Torrent Trackers and Usenet Indexers. It integrates seamlessly with Lidarr, Mylar3, Radarr, Readarr, and Sonarr offering complete management of your indexers with no per app Indexer setup required (we do it all).
  copyright:
    - license: GPL-3.0-only
  dependencies:
    runtime:
      - aspnet-8-runtime
      - sqlite-libs
environment:
  contents:
    packages:
      - wolfi-baselayout
      - busybox
      - dotnet-8-sdk
      - nodejs
      - yarn
      - jq
pipeline:
  - uses: git-checkout
    with:
      expected-commit: 7eb2d956cf1903e047de716a9c8164e0c2ce9945
      repository: https://github.com/Prowlarr/Prowlarr
      tag: v${{package.version}}
  - name: Build
    runs: |
      if [[ "${{build.arch}}" == "aarch64" ]]; then
        runtime_arch="arm64"
      elif [[ "${{build.arch}}" == "x86_64" ]]; then
        runtime_arch="x64"
      fi

      export BROWSERSLIST_IGNORE_OLD_DATA=true

      yarn install --frozen-lockfile --network-timeout 120000

      jq '.sdk.version = "8.0.120"' /home/build/global.json > /home/build/global.json.tmp && mv /home/build/global.json.tmp /home/build/global.json
      
      _dotnet_arch="$runtime_arch"
      _runtime="linux-$_dotnet_arch"
      _framework="net8.0"
      _output="_output"
      _destdir="${{targets.destdir}}/usr/lib/prowlarr"
      _artifacts="$_output/$_framework/$_runtime/publish"

      ulimit -n 4096

      dotnet publish src \
        -p:AssemblyConfiguration="master" \
        -p:AssemblyVersion="${{package.version}}" \
        -p:RuntimeIdentifier="$_runtime" \
        -p:Configuration=Release \
        -p:DebugSymbols=false \
        -p:DebugType=none \
        -p:SelfContained=false \
        -p:SentryCliExecutable= \
        -p:SentryUploadSymbols=false \
        -p:SentryIncludeSources=false \
        -p:EmbedAllSources=false \
        -f "$_framework"

      yarn run build --env production

      find "$_artifacts" \( \
        -name "ServiceUninstall.*" -o \
        -name "ServiceInstall.*" -o \
        -name "Prowlarr.Windows.*" \
      \) -delete

      mv "$_output"/UI "$_artifacts"

      echo "Preparing package"

      mkdir -p "$_destdir" "${{targets.destdir}}/usr/bin"

      printf "UpdateMethod=docker\nBranch=%s\nPackageVersion=%s\nPackageAuthor=[d4rkfella](https://github.com/d4rkfella)\n" "master" "${{package.version}}" > "$_destdir/package_info"

      cp -af "$_artifacts" "$_destdir/bin"

      ln -s /usr/lib/prowlarr/bin/Prowlarr "${{targets.destdir}}/usr/bin/Prowlarr"
test:
  environment:
    contents:
      packages:
        - curl
        - bash
        - jq
        - xmlstarlet
        - lttng-ust
  pipeline:
    - runs: ln -s /usr/lib/liblttng-ust.so.1 /usr/lib/liblttng-ust.so.0
    - name: Check for missing dependancies
      uses: test/tw/ldd-check
      with:
        packages: ${{package.name}}
    - name: Run test script
      runs: |
        EXPECTED_VERSION="${{package.version}}" ./test.sh
update:
  enabled: true
  github:
    identifier: Prowlarr/Prowlarr
    strip-prefix: v
