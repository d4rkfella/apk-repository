package:
  name: prowlarr
  version: "2.3.1.5238"
  epoch: 0
  description: Prowlarr is an indexer manager/proxy built on the popular *arr .net/reactjs base stack to integrate with your various PVR apps. Prowlarr supports management of both Torrent Trackers and Usenet Indexers. It integrates seamlessly with Lidarr, Mylar3, Radarr, Readarr, and Sonarr offering complete management of your indexers with no per app Indexer setup required (we do it all).
  copyright:
    - license: GPL-3.0-only
  dependencies:
    runtime:
      - aspnet-8-runtime
      - sqlite-libs
environment:
  environment:
    PACKAGE_UPDATE_USE_PRERELEASE: true
    BROWSERSLIST_IGNORE_OLD_DATA: true
  contents:
    packages:
      - wolfi-baselayout
      - dotnet-8-sdk
      - nodejs
      - yarn
      - jq
pipeline:
  - uses: git-checkout
    with:
      expected-commit: ed3b25b3d6ebf843d150b941e73995ff281318df
      repository: https://github.com/Prowlarr/Prowlarr
      tag: v${{package.version}}
  - name: Build
    runs: |
      if [[ "${{build.arch}}" == "aarch64" ]]; then
        runtime_arch="arm64"
      elif [[ "${{build.arch}}" == "x86_64" ]]; then
        runtime_arch="x64"
      fi
      
      export NODE_OPTIONS="--localstorage-file=/tmp/.localstorage"
      export BROWSERSLIST_IGNORE_OLD_DATA=true
      
      yarn install --frozen-lockfile --network-timeout 120000

      jq '.sdk.version = "8.0.120"' /home/build/global.json > /home/build/global.json.tmp && mv /home/build/global.json.tmp /home/build/global.json

      _dotnet_arch="$runtime_arch"
      _runtime="linux-$_dotnet_arch"
      _framework="net8.0"
      _output="_output"
      _destdir="${{targets.destdir}}/usr/lib/prowlarr"
      _artifacts="$_output/$_framework/$_runtime/publish"

      ulimit -n 4096

      dotnet publish src \
        -p:AssemblyConfiguration="master" \
        -p:AssemblyVersion="${{package.version}}" \
        -p:RuntimeIdentifier="$_runtime" \
        -p:Configuration=Release \
        -p:DebugSymbols=false \
        -p:DebugType=none \
        -p:SelfContained=false \
        -p:SentryCliExecutable= \
        -p:SentryUploadSymbols=false \
        -p:SentryIncludeSources=false \
        -p:EmbedAllSources=false \
        -f "$_framework"

      yarn run build --env production

      echo "Preparing package"

      mkdir -p "$_destdir" "${{targets.destdir}}/usr/bin"
      
      printf "UpdateMethod=docker\nBranch=%s\nPackageVersion=%s\nPackageAuthor=[d4rkfella](https://github.com/d4rkfella)\n" "develop" "${{package.version}}" > "$_destdir/package_info"
      
      cp -r "$_output/UI" "$_artifacts"
      cp -r $_output/Prowlarr.Update/$_framework/$_runtime/publish $_artifacts/Prowlarr.Update
      
      echo "Adding Prowlarr.Mono to UpdatePackage"
      cp $_artifacts/Prowlarr.Mono.* $_artifacts/Prowlarr.Update
      cp $_artifacts/Mono.Posix.NETStandard.* $_artifacts/Prowlarr.Update
      cp $_artifacts/libMonoPosixHelper.* $_artifacts/Prowlarr.Update

      echo "Removing Service helpers"
      rm -f $_artifacts/ServiceUninstall.*
      rm -f $_artifacts/ServiceInstall.*
  
      echo "Removing Prowlarr.Windows"
      rm $_artifacts/Prowlarr.Windows.*

      cp -af "$_artifacts" "$_destdir/bin"

      ln -s /usr/lib/prowlarr/bin/Prowlarr "${{targets.destdir}}/usr/bin/Prowlarr"
test:
  environment:
    contents:
      packages:
        - curl
        - bash
        - jq
        - xmlstarlet
        - lttng-ust
  pipeline:
    - runs: ln -s /usr/lib/liblttng-ust.so.1 /usr/lib/liblttng-ust.so.0
    - name: Check for missing dependancies
      uses: test/tw/ldd-check
      with:
        packages: ${{package.name}}
    - name: Run test script
      runs: |
        EXPECTED_VERSION="${{package.version}}" ./test.sh
update:
  enabled: true
  github:
    identifier: Prowlarr/Prowlarr
    strip-prefix: v
