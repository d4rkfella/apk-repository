package:
  name: autobrr
  version: "1.60.0"
  epoch: 0
  description: "Autobrr redefines download automation for torrents and Usenet, drawing inspiration from tools like trackarr, autodl-irssi, and flexget. We've combined the best of these worlds into one versatile tool that can do it all, and then some."
  copyright:
    - license: GPLv2-or-later
environment:
  contents:
    repositories:
      - https://dl-cdn.alpinelinux.org/alpine/edge/main
      - https://dl-cdn.alpinelinux.org/alpine/edge/community
    packages:
      - alpine-base
      - ca-certificates-bundle
      - nodejs
      - go
      - git
      - build-base
      - tzdata
pipeline:
  - uses: fetch
    with:
      uri: https://github.com/autobrr/autobrr/archive/refs/tags/v${{package.version}}.tar.gz
      expected-sha256: 7915aa4d7fd9b4fe596cb7d284c3b13d9b8a068c7f87caa53ff2c8b47f2f7c59
  - run: |
      corepack enable
      mkdir /tmp/web
      cp web/package.json web/pnpm-lock.yaml /tmp/web/
      cd /tmp/web
      pnpm install --frozen-lockfile
      cd ..
      cp web/* /tmp/web/
      pnpm run build
  - run: |
      mkdir -p /tmp/src/web/dist ${{targets.destdir}}/usr/bin
      cp src/go.mod src/go.sum /tmp/src
      cd /tmp/src && go mod download
      cp /tmp/web/dist/* /tmp/src/web/dist/*
      cp /tmp/web/build.go /tmp/src/web/build.go
      go build -ldflags "-s -w -o ${{targets.destdir}}/usr/bin/autobrr /tmp/src/cmd/autobrr/main.go
      go build -ldflags "-s -w -o ${{targets.destdir}}/usr/bin/autobrrctl /tmp/src/cmd/autobrrctl/main.go
