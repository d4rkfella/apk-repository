package:
  name: autobrr
  version: "1.60.0"
  epoch: 0
  description: "Autobrr download automation tool"
  copyright:
    - license: GPL-2.0-or-later

environment:
  contents:
    keyring:
      - https://packages.wolfi.dev/os/wolfi-signing.rsa.pub
    repositories:
      - https://packages.wolfi.dev/os
    packages:
      - ca-certificates-bundle
      - nodejs-20
      - corepack
      - go-1.23
      - git
      - build-base
      - tzdata
      - jq
      - busybox

pipeline:
  - uses: fetch
    with:
      uri: https://github.com/autobrr/autobrr/archive/refs/tags/v${{package.version}}.tar.gz
      expected-sha256: 7915aa4d7fd9b4fe596cb7d284c3b13d9b8a068c7f87caa53ff2c8b47f2f7c59

  - runs: |
      corepack enable
      cd web
      pnpm install --frozen-lockfile
      pnpm approve-builds
      pnpm run build

  - runs: |
      mkdir -p ${{targets.destdir}}/usr/bin
      
      export VERSION=${{package.version}}
      export REVISION=$(git -C . rev-parse --short HEAD 2>/dev/null || echo "unknown")
      export BUILDTIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
      echo $VERSION
      echo $REVISION
      echo $BUILDTIME
      go mod download
      go build -ldflags "-s -w -X main.version=${VERSION} -X main.commit=${REVISION} -X main.date=${BUILDTIME}" \
        -o ${{targets.destdir}}/usr/bin/autobrr cmd/autobrr/main.go
      go build -ldflags "-s -w -X main.version=${VERSION} -X main.commit=${REVISION} -X main.date=${BUILDTIME}" \
        -o ${{targets.destdir}}/usr/bin/autobrrctl cmd/autobrrctl/main.go
