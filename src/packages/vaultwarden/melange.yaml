package:
  name: vaultwarden
  version: "1.35.2"
  epoch: 1
  description: "Unofficial Bitwarden compatible server written in Rust (glibc)"
  copyright:
    - license: GPL-3.0-or-later
  dependencies:
    runtime:
      - wolfi-base
      - ca-certificates
      - openssl
      - libpq-18
      - curl
environment:
  environment:
    FEATURES: "postgresql"
    CHECKOUT_TAGS: false
  contents:
    packages:
      - wolfi-base
      - cargo-auditable
      - pkgconf
      - clang
      - rust
      - curl
      - openssl-dev
      - postgresql-dev
      - zlib-dev
      - bash
      - make
      - nodejs-22
      - npm
      - python-3.14
      - yq
pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/dani-garcia/vaultwarden
      tag: ${{package.version}}
      expected-commit: 4352fffeec7915e45559b46dce18640a25f46801
      destination: vaultwarden

  - uses: git-checkout
    with:
      repository: https://github.com/dani-garcia/bw_web_builds
      destination: bw_web_builds
  - name: build-web-vault
    working-directory: /home/build/bw_web_builds
    runs: |
      set -eux
      export WEB_VAULT_VERSION=$(yq '.vault_version' /home/build/vaultwarden/docker/DockerSettings.yaml | tr -d '"')
      echo ${WEB_VAULT_VERSION}
      git fetch --tags
      git checkout "${WEB_VAULT_VERSION}"
      make git-checkout
      cd web-vault
      npm ci
      cd apps/web
      npm run dist:oss:selfhost
      cd build
      printf '{"version":"%s"}\n' "v${WEB_VAULT_VERSION}" > vw-version.json
  - name: prepare-package
    runs: |
      mkdir -p ${{targets.destdir}}/usr/bin
      mkdir -p ${{targets.destdir}}/usr/lib/vw_web_vault
      cp /home/build/vaultwarden/target/${{build.arch}}-unknown-linux-gnu/release/vaultwarden ${{targets.destdir}}/usr/bin/vaultwarden
      install -m555 -D start.sh ${{targets.destdir}}/usr/bin/start.sh
      cp -r /home/build/bw_web_builds/web-vault/apps/web/build/* ${{targets.destdir}}/usr/lib/vw_web_vault
update:
  enabled: true
  github:
    identifier: dani-garcia/vaultwarden
    strip-prefix: v
