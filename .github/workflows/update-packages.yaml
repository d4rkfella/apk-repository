name: Update Melange Packages

on:
  schedule:
    - cron: '0 0 * * *'  # Runs daily at midnight
  workflow_dispatch:  # Allows manual trigger

jobs:
  update-melange:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install yq (for YAML processing)
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Find and update melange.yaml files
        run: |
          PROJECT_IDS=()
          for file in $(find . -name "melange.yaml"); do
            ID=$(yq e '.update.release-monitor.identifier' "$file")
            if [[ -n "$ID" && "$ID" != "null" ]]; then
              PROJECT_IDS+=("$ID")
            fi
          done
          echo "PROJECT_IDS=${PROJECT_IDS[*]}" >> $GITHUB_ENV

      - name: Run Fetch Versions Action
        id: fetch-version
        uses: chainguard-images/actions/release-monitoring@main
        with:
          project-id: "${{ env.PROJECT_IDS }}"
          api-token: ""
