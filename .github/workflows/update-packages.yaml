name: Update Melange Packages

on:
  schedule:
    - cron: '0 0 * * *'  # Runs daily at midnight
  workflow_dispatch:  # Allows manual trigger

jobs:
  check-updates:
    runs-on: ubuntu-latest
    outputs:
      identifiers: ${{ steps.extract-ids.outputs.identifiers }}
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@4d991eb9b905ef189e4c376166672c3f2f230481 # v2.11.0
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install yq
        run: |
          echo "Installing yq..."
          sudo apt-get update
          sudo apt-get install -y jq
          wget https://github.com/mikefarah/yq/releases/download/v4.18.1/yq_linux_amd64 -O /usr/local/bin/yq
          sudo chmod +x /usr/local/bin/yq
          yq --version

      - name: Extract identifiers and file paths
        id: extract-ids
        run: |
          echo "Extracting identifiers and file paths..."
      
          # Find all melange.yaml files and extract the identifier and their paths
          identifiers_and_paths=$(find . -name "melange.yaml" -exec bash -c '
            file="{}"
            # Extract the identifier from the file
            identifier=$(yq ".update.release-monitor.identifier" "$file")
            # Ensure the identifier is valid (not null or empty)
            if [[ "$identifier" != "null" && -n "$identifier" ]]; then
              echo "$file,$identifier"
            fi
          ' \;)
      
          echo "Found identifiers and paths:"
          echo "$identifiers_and_paths"
      
          # Initialize the array
          identifiers_array=()
      
          # Process each extracted entry and create the necessary JSON structure
          while IFS=, read -r path identifier; do
            # Add the file path and identifier to the array in the format needed
            identifiers_array+=("{\"path\":\"$path\",\"identifier\":\"$identifier\"}")
          done <<< "$identifiers_and_paths"
      
          # Join array elements into a single string with commas
          identifiers_json="[$(printf "%s," "${identifiers_array[@]}" | sed 's/,$//')]"
      
          echo "Array of identifiers and paths: $identifiers_json"
      
          # Set the result as an output using GITHUB_OUTPUT
          echo "identifiers=$identifiers_json" >> $GITHUB_OUTPUT

  release-monitoring:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    needs: check-updates
    strategy:
      matrix:
        identifier: ${{ fromJson(needs.check-updates.outputs.identifiers) }}
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@4d991eb9b905ef189e4c376166672c3f2f230481 # v2.11.0
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup melange
        uses: chainguard-dev/actions/setup-melange@58b5d1b6769b7e88dfa5c85bbc81a5a02eaca5bc # main

      - name: Install yq
        run: |
          echo "Installing yq..."
          sudo apt-get update
          sudo apt-get install -y jq
          wget https://github.com/mikefarah/yq/releases/download/v4.18.1/yq_linux_amd64 -O /usr/local/bin/yq
          sudo chmod +x /usr/local/bin/yq
          yq --version

      - name: Run release-monitoring for each identifier
        id: release-monitoring
        uses: chainguard-images/actions/release-monitoring@0c41b080c7a4d6f7caf510a1c6f67d593f687789 # main
        with:
          project-id: ${{ matrix.identifier.identifier }}

      - name: Check if an update is available
        id: check-bump
        run: |
          latest_version="${{ steps.release-monitoring.outputs.latest-version }}"
          current_version=$(yq ".package.version" "${{ matrix.identifier.path }}")
          echo "Current version: $current_version"
          echo "Latest version: $latest_version"
          
          # Compare versions using sort
          if [[ $(echo -e "$latest_version\n$current_version" | sort -V | head -n 1) != "$current_version" ]]; then
            echo "New version available: $latest_version. Proceeding with version bump."
            melange bump "${{ matrix.identifier.path }}" $latest_version
            echo "bumped=true" >> $GITHUB_ENV
          else
            echo "No new version available or the version is not newer. Skipping version bump."
            echo "bumped=false" >> $GITHUB_ENV
          fi
          cat "${{ matrix.identifier.path }}"

      - name: Commit changes
        if: env.bumped == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git add ${{ matrix.identifier.path }}
      
      - name: Commit and open a PR if version was bumped
        if: env.bumped == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          add-paths: |
            ${matrix.identifier.path}
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Bump package versions for ${matrix.identifier.path}"
          committer: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>
          author: ${{ github.actor }} <${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com>
          signoff: true
          branch: "bump-${matrix.identifier.path}"
          title: "Bump ${matrix.identifier.path} versions"
          body: |
            This PR bumps the versions of the ${matrix.identifier.path} package using melange.
          base: main
          labels: |
            version-bump
          delete-branch: true
