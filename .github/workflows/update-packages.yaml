name: Update Melange Packages

on:
  schedule:
    - cron: '0 0 * * *'  # Runs daily at midnight
  workflow_dispatch:  # Allows manual trigger

jobs:
  check-updates:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install yq
        run: |
          echo "Installing yq..."
          sudo apt-get update
          sudo apt-get install -y jq
          wget https://github.com/mikefarah/yq/releases/download/v4.18.1/yq_linux_amd64 -O /usr/local/bin/yq
          sudo chmod +x /usr/local/bin/yq
          yq --version

      - name: Find and extract identifiers
        id: extract-ids
        run: |
          echo "Extracting identifiers..."
          # Find and extract all identifiers from melange.yaml files
          identifiers=$(find . -name "melange.yaml" -exec yq '.update.release-monitor.identifier' {} \;)
          echo "Found identifiers: $identifiers"
          
          # Remove 'null' entries and store valid identifiers in a file
          echo "$identifiers" | grep -v "null" > identifiers.txt
          echo "Valid identifiers saved to identifiers.txt"

      - name: Set identifiers as environment variable
        id: set-ids
        run: |
          # Set identifiers to be used in the matrix
          identifiers=$(cat identifiers.txt)
          echo "identifiers=$identifiers" >> $GITHUB_ENV

      - name: Prepare matrix for release-monitoring action
        id: prepare-matrix
        run: |
          # Prepare matrix for dynamic use in the next job
          identifiers=$(cat identifiers.txt)
          echo "::set-output name=matrix::$(echo $identifiers | tr '\n' ' ')"  # Output identifiers as space-separated values

  release-monitoring:
    runs-on: ubuntu-latest
    needs: check-updates
    strategy:
      matrix:
        project_id: ${{fromJson(needs.check-updates.outputs.matrix)}}
    steps:
      - name: Run release-monitoring for each identifier
        uses: chainguard-images/actions/release-monitoring@main
        with:
          project-id: ${{ matrix.project_id }}
