name: Update Melange Packages

on:
  schedule:
    - cron: '0 0 * * *'  # Runs daily at midnight
  workflow_dispatch:  # Allows manual trigger

jobs:
  check-updates:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install yq
        run: |
          echo "Installing yq..."
          sudo apt-get update
          sudo apt-get install -y jq
          wget https://github.com/mikefarah/yq/releases/download/v4.18.1/yq_linux_amd64 -O /usr/local/bin/yq
          sudo chmod +x /usr/local/bin/yq
          yq --version

      - name: Find and extract identifiers
        id: extract-ids
        run: |
          echo "Extracting identifiers..."
          # Find and extract all identifiers from melange.yaml files
          identifiers=$(find . -name "melange.yaml" -exec yq '.update.release-monitor.identifier' {} \;)
          echo "Found identifiers: $identifiers"
          
          # Remove 'null' entries and store valid identifiers in a file
          echo "$identifiers" | grep -v "null" > identifiers.txt
          echo "Valid identifiers saved to identifiers.txt"

      - name: Run release-monitoring for each identifier
        run: |
          # Read identifiers from the file and loop over them
          while IFS= read -r id; do
            echo "Processing identifier: $id"
            # Trigger the release-monitoring action with the project-id for each identifier
            echo "Fetching versions for project id: $id"
            
            # Run the release-monitoring action for each identifier
            - name: Fetch versions for $id from release-monitoring.org
              uses: chainguard-images/actions/release-monitoring@main
              with:
                project-id: $id
          done < identifiers.txt
