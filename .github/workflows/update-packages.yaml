name: Update Melange Packages

on:
  schedule:
    - cron: '0 0 * * *'  # Runs daily at midnight
  workflow_dispatch:  # Allows manual trigger

jobs:
  check-updates:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install yq
        run: |
          echo "Installing yq..."
          sudo apt-get update
          sudo apt-get install -y jq
          wget https://github.com/mikefarah/yq/releases/download/v4.18.1/yq_linux_amd64 -O /usr/local/bin/yq
          sudo chmod +x /usr/local/bin/yq
          yq --version

      - name: Find and extract identifiers
        id: extract-ids
        run: |
          echo "Extracting identifiers..."
          # Find and extract all identifiers from melange.yaml files
          identifiers=$(find . -name "melange.yaml" -exec yq '.update.release-monitor.identifier' {} \;)
          echo "Found identifiers: $identifiers"
          # Set each identifier into the GitHub environment variable and run the update check
          for id in $identifiers; do
            echo "identifier=$id" >> "$GITHUB_ENV"
            echo "::group::Processing identifier: $id"
            
            # Run release-monitoring action to fetch updates for each identifier
            uses: chainguard-images/actions/release-monitoring@main
            with:
              project-id: $id  # Pass the identifier of each project
            echo "::endgroup::"
          done

      # Optional: Check update status (debugging/logging purposes)
      - name: Debug - Check update status
        run: |
          echo "Identifier ${{ env.identifier }}: Update check completed."
