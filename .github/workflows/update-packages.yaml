jobs:
  check-updates:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install yq
        run: |
          echo "Installing yq..."
          sudo apt-get update
          sudo apt-get install -y jq
          wget https://github.com/mikefarah/yq/releases/download/v4.18.1/yq_linux_amd64 -O /usr/local/bin/yq
          sudo chmod +x /usr/local/bin/yq
          yq --version

      - name: Find and extract identifiers
        id: extract-ids
        run: |
          echo "Extracting identifiers..."
          # Find and extract all identifiers from melange.yaml files
          identifiers=$(find . -name "melange.yaml" -exec yq '.update.release-monitor.identifier' {} \;)
          echo "Found identifiers: $identifiers"
          
          # Remove 'null' entries and loop over valid identifiers
          identifiers=$(echo "$identifiers" | grep -v "null")
          
          # Iterate over valid identifiers and trigger release-monitoring action
          for id in $identifiers; do
            echo "Processing identifier: $id"
            echo "identifier=$id" >> "$GITHUB_ENV"
            echo "::group::Running release-monitoring for identifier: $id"
            
            # Run the release-monitoring action for each identifier
            - name: Fetch versions for $id from release-monitoring.org
              uses: chainguard-images/actions/release-monitoring@main
              with:
                project-id: $id
            
            echo "::endgroup::"
          done

      - name: Debug - Check update status
        run: |
          echo "Identifiers checked: ${{ env.identifier }}."
