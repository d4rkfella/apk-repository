name: Regenerate INDEX

on: 
  workflow_dispatch:

permissions:
  contents: read

jobs:    
  regenerate-index:
    runs-on: ubuntu-24.04
    steps:     
      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@master
      
      - name: Install dependencies
        run: |
          brew install melange
          brew install jfrog-cli
      
      - name: Save private key
        run: |
          set +x
          echo -n "${{ secrets.MELANGE_PRIVATE_KEY }}" > ${{ github.workspace }}/melange.rsa
          chmod 400 ${{ github.workspace }}/melange.rsa
          set -x
          
      - name: Configure JFrog CLI
        run: |
          jf c add artifactory \
            --url=https://packages.darkfellanetwork.com/artifactory \
            --access-token="${{ secrets.ARTIFACTORY_ACCESS_TOKEN }}" \
            --interactive=false
      
      - name: Download packages from Artifactory
        run: |
          mkdir -p /tmp/packages
          jf rt download "wolfi-os/x86_64/" /tmp/packages/ --include="*.apk" --flat=true
      
      - name: Regenerate index
        run: |
          melange index \
            --signing-key ${{ github.workspace }}/melange.rsa \
            --output /tmp/APKINDEX.tar.gz \
            /tmp/packages/*.apk
      
      - name: Upload index to Artifactory
        run: |
          jf rt upload /tmp/APKINDEX.tar.gz "wolfi-os/x86_64/APKINDEX.tar.gz"
