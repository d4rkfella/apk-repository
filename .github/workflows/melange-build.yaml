name: Build Packages

on: 
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-24.04
    permissions:
      contents: write
    
    steps:
      - name: Setup Qemu Action
        uses: docker/setup-qemu-action@v3.6.0
        
      - name: Generate snapshot date
        id: snapshot-date
        run: |
          echo "epoch=$(date -u +%s)" >> $GITHUB_OUTPUT
        shell: bash
      
      - name: Save private key
        run: |
          set +x
          echo -n "${{ secrets.MELANGE_PRIVATE_KEY }}" > /tmp/melange.rsa
          chmod 600 /tmp/melange.rsa
          set -x
      
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 #v4.2.2
  
      - name: Setup Homebrew
        uses: Homebrew/actions/setup-homebrew@a13eda877cb779461da1de25f0991398d655b35c

      - name: Install Melange
        run: brew install melange

      - name: Build APKs
        run: |
          for yaml_file in $(find ./src/packages -name "melange.yaml" | sort); do
            echo "Building package with $yaml_file"
            melange build --debug --namespace wolfi --runner quemu --pipeline-dir ./pipelines --empty-workspace --signing-key /tmp/melange.rsa --arch amd64 --out-dir ./pkg "$yaml_file"
          done

      - name: Commit and Push APK files
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git checkout main
          git pull origin main

          git add pkg/
          git commit -m "Add built APKs from workflow run ${{ github.run_id }}"
          git push origin main
