name: Build Packages

on:
  push:
    branches: ["main"]
    paths: ["src/packages/**/melange.yaml"]
  workflow_dispatch:
    inputs:
      apps:
        description: "Comma-separated list of app folders (e.g. radarr,sonarr)"
        required: false
        default: ""

permissions:
  contents: read

jobs:
  detect-packages:
    runs-on: ubuntu-24.04
    outputs:
      packages: ${{ steps.set-packages.outputs.packages }}
    steps:
      - uses: actions/checkout@v4

      - id: changed-files
        if: github.event_name == 'push'
        uses: tj-actions/changed-files@v46
        with:
          files: src/packages/**/melange.yaml
          matrix: true

      - id: set-packages-push
        if: github.event_name == 'push'
        run: |
          echo "::set-output name=packages::${{ steps.changed-files.outputs.all_changed_files }}"

      - id: set-packages-dispatch
        if: github.event_name == 'workflow_dispatch'
        run: |
          apps="${{ github.event.inputs.apps }}"
          if [ -z "$apps" ]; then
            pkgs=$(find src/packages -name 'melange.yaml' | jq -R -s -c 'split("\n") | map(select(length > 0))')
          else
            IFS=',' read -ra app_array <<< "$apps"
            files=()
            for app in "${app_array[@]}"; do
              file="src/packages/$app/melange.yaml"
              if [ -f "$file" ]; then
                files+=("$file")
              else
                echo "::warning::File not found: $file"
              fi
            done
            pkgs=$(printf "%s\n" "${files[@]}" | jq -R -s -c 'split("\n") | map(select(length > 0))')
          fi
          echo "::set-output name=packages::$pkgs"

      - id: set-packages
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            echo "::set-output name=packages::${{ steps.set-packages-push.outputs.packages }}"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "::set-output name=packages::${{ steps.set-packages-dispatch.outputs.packages }}"
          else
            echo "::set-output name=packages::[]"
          fi

  setup:
    needs: detect-packages
    if: ${{ needs.detect-packages.outputs.packages != '[]' }}
    strategy:
      matrix:
        arch: [x86_64, aarch64]
      max-parallel: 2
    uses: ./.github/workflows/setup-build-dependencies.yaml
    with:
      arch: ${{ matrix.arch }}

  build:
    needs: [detect-packages, setup]
    if: ${{ needs.detect-packages.outputs.packages != '[]' }}
    strategy:
      matrix:
        packages: ${{ fromJSON(needs.detect-packages.outputs.packages) }}
        arch: [x86_64, aarch64]
      max-parallel: 4
      fail-fast: false
    runs-on: ${{ matrix.arch == 'x86_64' && 'ubuntu-24.04' || 'ubuntu-24.04-arm' }}
    steps:
      - name: Retrieve Cache Key
        id: cache
        run: echo "key=$(date -u +'%G-%V')" >> $GITHUB_OUTPUT

      - name: Restore build dependencies
        uses: actions/cache/restore@v4
        with:
          key: build-dependencies-${{ matrix.arch }}-${{ steps.cache.outputs.key }}
          fail-on-cache-miss: true
          path: |
            /usr/local/bin/jf
            /usr/local/bin/bwrap
            /usr/local/bin/melange
            /usr/local/bin/yq

      - uses: actions/checkout@v4

      - name: Build Packages
        uses: d4rkfella/actions/melange-build@main
        with:
          archs: ${{ matrix.arch }}
          artifactory-access-token: ${{ secrets.ARTIFACTORY_ACCESS_TOKEN }}
          artifactory-url: https://packages.darkfellanetwork.com
          artifactory-repository-path: wolfi-apk
          config: ${{ matrix.packages }}
          sign-with-key: true
          signing-key-path: ${{ github.workspace }}/melange.rsa
          namespace: wolfi
          pipeline-dir: ${{ github.workspace }}/pipelines
          repository-append: https://packages.darkfellanetwork.com/artifactory/wolfi-os,https://packages.wolfi.dev/os
          keyring-append: https://packages.darkfellanetwork.com/artifactory/wolfi-os/melange.rsa.pub,https://packages.wolfi.dev/os/wolfi-signing.rsa.pub
          tests-repository-append: https://packages.darkfellanetwork.com/artifactory/wolfi-os,https://packages.wolfi.dev/os
          tests-keyring-append: https://packages.darkfellanetwork.com/artifactory/wolfi-os/melange.rsa.pub,https://packages.wolfi.dev/os/wolfi-signing.rsa.pub
        env:
          MELANGE_PRIVATE_KEY: ${{ secrets.MELANGE_PRIVATE_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
