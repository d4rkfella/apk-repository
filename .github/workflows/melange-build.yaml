name: Build Packages

on: 
  push:
    branches: ["main"]
    paths: ["src/packages/**/melange.yaml"]

permissions:
  contents: read

jobs:
  changed-files:
    runs-on: ubuntu-24.04
    outputs:
      packages: ${{ steps.changed-files.outputs.all_changed_files }}   
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@4d991eb9b905ef189e4c376166672c3f2f230481 # v2.11.0
        with:
          egress-policy: audit
      
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 #v4.2.2
      
      - name: Get Changed Files
        id: changed-files
        uses: JJGadgets/tj-actions-changed-files@9200e69727eb73eb060652b19946b8a2fdfb654b
        with:
          files: src/packages/**/melange.yaml
          matrix: true      
  
  build:
    needs: changed-files
    runs-on: ubuntu-24.04
    if: ${{ needs.changed-files.outputs.packages != '[]' }}
    strategy:
      matrix:
        packages: ${{ fromJSON(needs.changed-files.outputs.packages) }}
      max-parallel: 4
      fail-fast: false
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 #v4.2.2
              
      - name: Generate snapshot date
        id: snapshot-date
        run: |
          echo "epoch=$(date -u +%s)" >> $GITHUB_OUTPUT
        shell: bash
      
      - name: Save private key
        run: |
          set +x
          echo -n "${{ secrets.MELANGE_PRIVATE_KEY }}" > /tmp/melange.rsa
          chmod 444 /tmp/melange.rsa
          set -x
      
      - name: Build Packages
        uses: d4rkfella/actions/melange-build@main
        with:
          config: ${{ matrix.packages }}
          archs: amd64
          signing-key-path: /tmp/melange.rsa
          namespace: wolfi

      - name: Download the latest index file
        run: |
          aws s3 cp s3://packages/x86_64/APKINDEX.tar.gz /tmp --endpoint-url=$ENDPOINT_URL
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          ENDPOINT_URL: ${{ secrets.AWS_ENDPOINT_URL }}
      
      - name: Merge Index
        run: |
          melange index --signing-key /tmp/melange.rsa --source /tmp/APKINDEX.tar.gz --merge --output ./pkg/x86_64/APKINDEX.tar.gz ./pkg/x86_64/*.apk
      
      - name: Upload packages to S3 bucket
        run: |
          aws s3 cp --recursive pkg/ s3://packages/ --endpoint-url $ENDPOINT_URL --checksum-algorithm CRC32
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          ENDPOINT_URL: ${{ secrets.AWS_ENDPOINT_URL }}
